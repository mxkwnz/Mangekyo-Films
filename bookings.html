<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Мои брони — Кинотеатр</title>
  <link rel="stylesheet" href="static/css/auth-modal.css">
</head>
<body>
  <header>
    <h1>Кинотеатр</h1>
    <nav>
      <a href="index.html">Афиша</a>
      <a href="bookings.html">Мои брони</a>
      <a href="admin.html" id="nav-admin" style="display:none;">Админ</a>
      <span id="user-span"></span>
    </nav>
  </header>
  <main id="bookings-main">
    <h2>Мои брони</h2>
    <div id="bookings-guest" style="display:none;">
      <p>Чтобы видеть брони, войдите в аккаунт.</p>
      <button type="button" id="bookings-login-btn">Вход / Регистрация</button>
    </div>
    <div id="bookings-list-wrap" style="display:none;">
      <p id="bookings-empty" style="display:none;">У вас пока нет бронирований.</p>
      <ul id="bookings-list"></ul>
    </div>
    <p id="bookings-error" class="error-msg" style="display:none;"></p>
  </main>
  <script src="static/js/auth.js"></script>
  <script>
(function () {
  var API_BASE = window.API_BASE || '/api';

  function authHeaders() {
    return window.auth && window.auth.getAuthHeaders ? window.auth.getAuthHeaders() : {};
  }

  function updateNav() {
    var span = document.getElementById('user-span');
    var navAdmin = document.getElementById('nav-admin');
    if (navAdmin) navAdmin.style.display = auth.isAdmin() ? '' : 'none';
    if (!span) return;
    if (auth.isLoggedIn()) {
      var u = auth.getUser();
      span.innerHTML = 'Привет, ' + (u.first_name || u.email) + ' | <a href="index.html">На главную</a> | <button type="button" id="logout-btn">Выйти</button>';
      var btn = document.getElementById('logout-btn');
      if (btn) btn.onclick = function () { auth.logout(); location.href = 'index.html'; };
    } else {
      span.innerHTML = '<button type="button" id="login-btn">Вход / Регистрация</button>';
      var loginBtn = document.getElementById('login-btn');
      if (loginBtn) loginBtn.onclick = function () { openAuthModal({ onSuccess: load }); };
    }
  }

  function showGuest() {
    document.getElementById('bookings-guest').style.display = 'block';
    document.getElementById('bookings-list-wrap').style.display = 'none';
    document.getElementById('bookings-login-btn').onclick = function () {
      openAuthModal({ onSuccess: function () { load(); updateNav(); } });
    };
  }

  function showError(msg) {
    var el = document.getElementById('bookings-error');
    el.textContent = msg || '';
    el.style.display = msg ? 'block' : 'none';
  }

  function load() {
    if (!auth.isLoggedIn()) {
      showGuest();
      updateNav();
      return;
    }
    document.getElementById('bookings-guest').style.display = 'none';
    document.getElementById('bookings-list-wrap').style.display = 'block';
    showError('');

    fetch(API_BASE + '/bookings/my', { headers: authHeaders() })
      .then(function (r) { return r.json(); })
      .then(function (data) {
        var list = document.getElementById('bookings-list');
        var empty = document.getElementById('bookings-empty');
        list.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
          empty.style.display = 'block';
          return;
        }
        empty.style.display = 'none';
        data.forEach(function (ticket) {
          var li = document.createElement('li');
          li.dataset.id = ticket.id;
          li.innerHTML =
            'Сеанс: ' + (ticket.session_id || '') + ' — ряд ' + (ticket.row_number || '') + ', место ' + (ticket.seat_number || '') +
            ' — статус: ' + (ticket.status || '') +
            ' <button type="button" class="cancel-ticket-btn" data-id="' + (ticket.id || '') + '">Отменить</button>';
          list.appendChild(li);
        });
        list.querySelectorAll('.cancel-ticket-btn').forEach(function (btn) {
          btn.onclick = function () {
            var id = btn.getAttribute('data-id');
            if (!id) return;
            if (!confirm('Отменить бронирование?')) return;
            fetch(API_BASE + '/bookings/' + id, {
              method: 'DELETE',
              headers: authHeaders()
            })
              .then(function (r) { return r.json().then(function (d) { return { ok: r.ok, data: d }; }); })
              .then(function (res) {
                if (res.ok) load();
                else showError(res.data.error || 'Ошибка отмены');
              })
              .catch(function () { showError('Ошибка сети'); });
          };
        });
      })
      .catch(function () {
        showError('Не удалось загрузить брони.');
      });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function () {
      updateNav();
      load();
    });
  } else {
    updateNav();
    load();
  }
})();
  </script>
</body>
</html>
